name: 编译 HMA-OSS（Debug + Release）
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  build-all:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          lfs: false
          submodules: true
          submodules-depth: 1

      - name: 配置 JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: 配置 Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0
          ndk-version: 26.1.10909125
          cmake-version: 3.22.1
          components: platform-tools,tools,extras;android;m2repository,extras;google;m2repository

      - name: 自动检测包名 + 清理 Crowdin（核心修复）
        shell: bash
        run: |
          set +e
          echo "=== 自动检测项目真实包名 ==="

          # 1. 授权文件可修改
          find . -name "build.gradle*" -o -name "gradle.properties" | xargs chmod +w 2>/dev/null || true

          # 2. 自动提取 app/build.gradle.kts 中的 namespace（真实包名）
          APP_GRADLE_KTS="app/build.gradle.kts"
          DEFAULT_PACKAGE="com.frknkrc44.hma"
          REAL_PACKAGE=""

          if [ -f "$APP_GRADLE_KTS" ]; then
            # 从 android { namespace "xxx" } 中提取包名（适配 KTS 语法）
            REAL_PACKAGE=$(grep -r "namespace" "$APP_GRADLE_KTS" | sed -n 's/.*namespace\s*["'\'']\([^"'\'']*\)["'\''].*/\1/p' | head -1)
          fi

          # 3. 验证包名（提取失败则用默认值）
          if [ -n "$REAL_PACKAGE" ] && [[ "$REAL_PACKAGE" =~ ^[a-zA-Z0-9.]+$ ]]; then
            echo "✅ 成功提取真实包名：$REAL_PACKAGE"
          else
            echo "⚠️  未提取到包名，使用默认包名：$DEFAULT_PACKAGE"
            REAL_PACKAGE="$DEFAULT_PACKAGE"
          fi

          # 4. 彻底清理 Crowdin 相关内容
          find . -name "build.gradle*" -type f | while read -r FILE; do
            sed -i '/id.*crowdin.*/d' "$FILE"
            sed -i '/implementation.*crowdin.*/d' "$FILE"
            sed -i '/crowdin {/,/}/d' "$FILE"
            sed -i '/crowdin/d' "$FILE"
          done
          find . -name "gradle.properties" -type f | xargs sed -i '/crowdin/d' 2>/dev/null || true

          # 5. 双保险定义 appPackageName（用真实包名）
          APP_GRADLE_PROP="app/gradle.properties"
          # 写入 gradle.properties（全局可访问）
          if [ -f "$APP_GRADLE_PROP" ]; then
            echo "appPackageName=$REAL_PACKAGE" >> "$APP_GRADLE_PROP"
          else
            mkdir -p app && echo "appPackageName=$REAL_PACKAGE" > "$APP_GRADLE_PROP"
          fi
          echo "✅ 已在 $APP_GRADLE_PROP 定义 appPackageName=$REAL_PACKAGE"

          # 写入 app/build.gradle.kts 的 android 块内（精准作用域）
          if [ -f "$APP_GRADLE_KTS" ]; then
            sed -i '/android {/a \
              extra["appPackageName"] = project.findProperty("appPackageName") as String\
            ' "$APP_GRADLE_KTS"
            echo "✅ 已在 $APP_GRADLE_KTS 的 android 块内定义属性"
          fi

          # 6. 禁用 Crowdin 任务
          ROOT_GRADLE=$(find . -maxdepth 1 -name "build.gradle*" | head -1)
          if [ -n "$ROOT_GRADLE" ]; then
            echo '
            tasks.whenTaskAdded {
                if (name.contains("crowdin") || className.contains("crowdin")) enabled = false
            }
            ' >> "$ROOT_GRADLE"
          fi

          set -e
          echo "=== 包名配置完成 ==="

      - name: 授权 Gradle 执行权限
        run: chmod +x ./gradlew 2>/dev/null || true
        shell: bash

      - name: 清理缓存
        run: ./gradlew clean --no-daemon -x :crowdinSync -x :app:crowdinSync 2>/dev/null || true
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}

      - name: 编译 Debug + Release
        run: ./gradlew assembleDebug assembleRelease --no-daemon --stacktrace -x :crowdinSync -x :app:crowdinSync
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          JAVA_OPTS: "-Xmx4g"
          CROWDIN_PROJECT_ID: ""
          CROWDIN_API_TOKEN: ""
        shell: bash

      - name: 捕获失败日志
        if: failure()
        run: |
          echo "=== 包名提取详情 ==="
          grep -r "namespace" "app/build.gradle.kts" 2>/dev/null
          echo "=== app/gradle.properties 内容 ==="
          cat "app/gradle.properties" 2>/dev/null
          echo "=== 第 53 行前后代码 ==="
          sed -n '45,60p' "app/build.gradle.kts" 2>/dev/null
          echo "=== Gradle 日志片段 ==="
          cat ~/.gradle/daemon/17.0/daemon-*.out.log 2>/dev/null | tail -300
        shell: bash

      - name: 重命名 APK（含包名标识）
        run: |
          # 提取包名用于 APK 命名
          REAL_PACKAGE=$(grep -r "appPackageName" "app/gradle.properties" | sed -n 's/.*appPackageName=\(.*\)/\1/p')
          DATE=$(date +%Y%m%d)
          find . -name "*.apk" -path "*/apk/debug/*" -exec mv {} $(dirname {})/HMA-OSS-${REAL_PACKAGE##*.}-Debug-$DATE.apk \; 2>/dev/null || true
          find . -name "*.apk" -path "*/apk/release/*" -exec mv {} $(dirname {})/HMA-OSS-${REAL_PACKAGE##*.}-Release-$DATE.apk \; 2>/dev/null || true
        shell: bash

      - name: 上传所有 APK 产物
        uses: actions/upload-artifact@v4
        with:
          name: HMA-OSS-APKs
          path: '**/apk/**/*.apk'
          retention-days: 30

      - name: 上传混淆映射文件
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: HMA-OSS-Proguard-Mapping
          path: '**/mapping/release/mapping.txt'
          retention-days: 30
