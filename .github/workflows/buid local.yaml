name: 编译 HMA-OSS（Debug + Release）
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  build-all:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码（含子模块）
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          lfs: false
          submodules: true
          submodules-depth: 1
          # 强制同步子模块（解决 common/xposed 模块缺失问题）
          fetch-submodules: recursive

      - name: 配置 JDK 17（匹配 Toolchain 17）
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: 配置 Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0
          ndk-version: 26.1.10909125
          cmake-version: 3.22.1
          components: platform-tools,tools,extras;android;m2repository,extras;google;m2repository

      - name: 根治核心问题（多模块+JVM+代码残留）
        shell: bash
        run: |
          set +e
          APP_GRADLE_KTS="app/build.gradle.kts"
          ROOT_GRADLE_KTS="build.gradle.kts"

          # 1. 提取真实包名（从 app 模块 namespace）
          REAL_PACKAGE=$(grep -r "namespace" "$APP_GRADLE_KTS" | sed -n 's/.*namespace\s*["'\'']\([^"'\'']*\)["'\''].*/\1/p' | head -1)
          REAL_PACKAGE=${REAL_PACKAGE:-"com.frknkrc44.hma"}
          echo "✅ 真实包名：$REAL_PACKAGE"

          # 2. 根项目：注入 rootProject.extra（完全匹配代码）
          chmod +w "$ROOT_GRADLE_KTS" 2>/dev/null || true
          sed -i '/rootProject.extra {/,/}/d' "$ROOT_GRADLE_KTS"
          sed -i '1i \
          rootProject.extra { \
              set("appPackageName", "'"$REAL_PACKAGE"'") \
              set("crowdinProjectId", "") \
              set("crowdinApiKey", "") \
              set("localBuild", true) \
              set("officialBuild", false) \
          }\
          ' "$ROOT_GRADLE_KTS"

          # 3. app 模块：彻底清理 Crowdin 相关代码（避免残留语法）
          chmod +w "$APP_GRADLE_KTS" 2>/dev/null || true
          # 精准删除 Crowdin API 调用块（含 if 条件）
          sed -i '/if (localBuild || officialBuild) {/,/}/d' "$APP_GRADLE_KTS"
          # 删除 translatorsMap 定义（无 API 调用则无用）
          sed -i '/val translatorsMap = mutableMapOf(/,/)/d' "$APP_GRADLE_KTS"
          # 清理空行和多余导入
          sed -i '/^[[:space:]]*$/d' "$APP_GRADLE_KTS"
          sed -i '/import org.jose4j.json.internal.json_simple.JSONObject/d' "$APP_GRADLE_KTS"
          sed -i '/import java.io.DataInputStream/d' "$APP_GRADLE_KTS"
          sed -i '/import java.net.HttpURLConnection/d' "$APP_GRADLE_KTS"
          sed -i '/import java.net.URL/d' "$APP_GRADLE_KTS"

          # 4. 修复 JVM Toolchain 版本不兼容（JDK 17 → Toolchain 17）
          sed -i 's/jvmToolchain(21)/jvmToolchain(17)/g' "$APP_GRADLE_KTS"
          echo "✅ 已将 Kotlin JVM Toolchain 从 21 改为 17（匹配 JDK 17）"

          # 5. 验证子模块存在（common/xposed）
          echo "=== 项目模块结构 ==="
          ls -la || true
          ls -la common/ 2>/dev/null || echo "⚠️ common 模块缺失"
          ls -la xposed/ 2>/dev/null || echo "⚠️ xposed 模块缺失"

          # 6. 根项目：最终语法清理
          sed -i '/@Suppress/d' "$ROOT_GRADLE_KTS"
          sed -i '/tasks.whenTaskAdded/d' "$ROOT_GRADLE_KTS"
          OPEN_BRACES=$(grep -o "{" "$ROOT_GRADLE_KTS" | wc -l)
          CLOSE_BRACES=$(grep -o "}" "$ROOT_GRADLE_KTS" | wc -l)
          [ $CLOSE_BRACES -gt $OPEN_BRACES ] && sed -i '$!N;$!N;/}\n*$/!P;D' "$ROOT_GRADLE_KTS"
          echo 'tasks.whenTaskAdded { if (name.lowercase().contains("crowdin")) enabled = false }' >> "$ROOT_GRADLE_KTS"

          set -e
          echo "=== 所有问题修复完成 ==="

      - name: 授权 Gradle 执行权限
        run: chmod +x ./gradlew 2>/dev/null || true
        shell: bash

      - name: 清理缓存
        run: ./gradlew clean --no-daemon 2>/dev/null || true
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}

      - name: 编译（带依赖校验）
        run: ./gradlew assembleDebug assembleRelease --no-daemon --stacktrace --info
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          JAVA_OPTS: "-Xmx4g"
        shell: bash

      - name: 捕获最终错误日志
        if: failure()
        run: |
          echo "=== 子模块详情 ==="
          git submodule status || true
          echo "=== 依赖错误详情 ==="
          cat ~/.gradle/daemon/17.0/daemon-*.out.log 2>/dev/null | grep -E "could not find|missing|unsatisfied|Toolchain" | tail -50
          echo "=== app 模块最终代码片段 ==="
          sed -n '30,60p' "$APP_GRADLE_KTS" 2>/dev/null
        shell: bash

      - name: 上传 APK 产物
        uses: actions/upload-artifact@v4
        with:
          name: HMA-OSS-APKs
          path: '**/apk/**/*.apk'
          retention-days: 30

      - name: 上传混淆映射文件
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: HMA-OSS-Proguard-Mapping
          path: '**/mapping/release/mapping.txt'
          retention-days: 30
