name: Main

on:
  push:
    branches: [ master ]
    paths-ignore:
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/workflows/issue.yml'
      - '.github/workflows/pull_request.yml'
      - '**.md'
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
    if: ${{ !startsWith(github.event.head_commit.message, '[skip ci]') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: 配置 Android SDK（带环境变量强注入）
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0
          ndk-version: 26.1.10909125
          cmake-version: 3.22.1
          components: |
            platform-tools
            tools
            build-tools;34.0.0
            platforms;android-34
            ndk;26.1.10909125
            extras;android;m2repository
            extras;google;m2repository
        env:
          ANDROID_HOME: /usr/local/lib/android/sdk
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

      - name: 穿透式修复（子模块+环境+依赖）
        shell: bash
        run: |
          set +e
          APP_GRADLE_KTS="app/build.gradle.kts"
          ROOT_GRADLE_KTS="build.gradle.kts"
          SETTINGS_GRADLE_KTS="settings.gradle.kts"

          # 1. 子模块路径强制配置（不依赖自动查找）
          chmod +w "$SETTINGS_GRADLE_KTS" 2>/dev/null || true
          sed -i '/include(":common")/d' "$SETTINGS_GRADLE_KTS"
          sed -i '/include(":xposed")/d' "$SETTINGS_GRADLE_KTS"
          sed -i '/project(":common").projectDir/d' "$SETTINGS_GRADLE_KTS"
          sed -i '/project(":xposed").projectDir/d' "$SETTINGS_GRADLE_KTS"
          # 假设子模块在根目录（若实际在子目录，手动修改路径）
          echo 'include(":common")' >> "$SETTINGS_GRADLE_KTS"
          echo 'project(":common").projectDir = file("./common")' >> "$SETTINGS_GRADLE_KTS"
          echo 'include(":xposed")' >> "$SETTINGS_GRADLE_KTS"
          echo 'project(":xposed").projectDir = file("./xposed")' >> "$SETTINGS_GRADLE_KTS"
          echo "=== 强制配置子模块路径为根目录下 ==="

          # 2. 根项目环境变量穿透配置
          chmod +w "$ROOT_GRADLE_KTS" 2>/dev/null || true
          sed -i '/allprojects {/,/}/d' "$ROOT_GRADLE_KTS"
          echo '
          allprojects {
              repositories {
                  google()
                  mavenCentral()
                  jcenter() // 兼容旧依赖
              }
              // 强制传递环境变量到所有子模块
              gradle.projectsEvaluated {
                  tasks.withType(JavaCompile) {
                      options.environment["ANDROID_HOME"] = System.getenv("ANDROID_HOME")
                      options.environment["ANDROID_SDK_ROOT"] = System.getenv("ANDROID_SDK_ROOT")
                      options.environment["NDK_HOME"] = System.getenv("ANDROID_HOME") + "/ndk/26.1.10909125"
                  }
              }
          }
          ' >> "$ROOT_GRADLE_KTS"

          # 3. 属性注入+全模块清理
          REAL_PACKAGE=$(grep -r "namespace" "$APP_GRADLE_KTS" | sed -n 's/.*namespace\s*["'\'']\([^"'\'']*\)["'\''].*/\1/p' | head -1)
          REAL_PACKAGE=${REAL_PACKAGE:-"com.frknkrc44.hma"}
          sed -i '/rootProject.extra {/,/}/d' "$ROOT_GRADLE_KTS"
          sed -i '1i \
          rootProject.extra { \
              set("appPackageName", "'"$REAL_PACKAGE"'") \
              set("crowdinProjectId", "") \
              set("crowdinApiKey", "") \
              set("localBuild", true) \
              set("officialBuild", false) \
          }\
          ' "$ROOT_GRADLE_KTS"

          # 子模块namespace避免冲突
          for MODULE in common xposed; do
            MODULE_GRADLE="$MODULE/build.gradle.kts"
            if [ -f "$MODULE_GRADLE" ]; then
              chmod +w "$MODULE_GRADLE" 2>/dev/null || true
              sed -i '/namespace =/d' "$MODULE_GRADLE"
              sed -i '/android {/a \
                  namespace = "'"$REAL_PACKAGE"'.'"$MODULE"'" \
              ' "$MODULE_GRADLE"
              sed -i 's/jvmToolchain(17)/jvmToolchain(21)/g' "$MODULE_GRADLE" 2>/dev/null
              echo "✅ 配置 $MODULE 模块namespace：$REAL_PACKAGE.$MODULE"
            fi
          done

          set -e
          echo "=== 穿透式修复完成 ==="

      - name: Gradle wrapper validation
        uses: gradle/wrapper-validation-action@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Write key
        if: github.event_name != 'pull_request' && github.ref == 'refs/heads/master'
        run: |
          echo officialBuild=false >> local.properties

      - name: 依赖缓存+重试配置
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/settings.gradle.kts') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: 单独编译 common 模块（带重试）
        run: |
          export ANDROID_HOME=/usr/local/lib/android/sdk
          export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
          export NDK_HOME=$ANDROID_HOME/ndk/26.1.10909125
          # 依赖下载重试3次，编译重试2次
          for i in {1..2}; do
            ./gradlew :common:assemble --no-daemon --stacktrace --info && break
            echo "⚠️ common 模块编译失败，第 $i 次重试"
            sleep 5
          done
        env:
          JAVA_OPTS: "-Xmx4g"

      - name: 单独编译 xposed 模块（带重试）
        run: |
          export ANDROID_HOME=/usr/local/lib/android/sdk
          export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
          export NDK_HOME=$ANDROID_HOME/ndk/26.1.10909125
          for i in {1..2}; do
            ./gradlew :xposed:assemble --no-daemon --stacktrace --info && break
            echo "⚠️ xposed 模块编译失败，第 $i 次重试"
            sleep 5
          done
        env:
          JAVA_OPTS: "-Xmx4g"

      - name: 编译 app 模块（依赖子模块）
        id: buildAll
        run: |
          export ANDROID_HOME=/usr/local/lib/android/sdk
          export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
          export NDK_HOME=$ANDROID_HOME/ndk/26.1.10909125
          ./gradlew :app:assembleDebug :app:assembleRelease --no-daemon --stacktrace --info
          # 安全提取 APK
          RELEASE_FILE=$(find app/build/outputs/apk/release -name "*.apk" | head -1 || echo "")
          DEBUG_FILE=$(find app/build/outputs/apk/debug -name "*.apk" | head -1 || echo "")
          echo "releaseName=$(basename "$RELEASE_FILE" 2>/dev/null)" >> $GITHUB_OUTPUT
          echo "debugName=$(basename "$DEBUG_FILE" 2>/dev/null)" >> $GITHUB_OUTPUT
          echo "releaseFile=$RELEASE_FILE" >> $GITHUB_OUTPUT
          echo "debugFile=$DEBUG_FILE" >> $GITHUB_OUTPUT
          echo "ossNum=$(basename "$DEBUG_FILE" 2>/dev/null | awk -F '-' '{print $4}' | sed 's/.apk//' 2>/dev/null)" >> $GITHUB_OUTPUT
        env:
          JAVA_OPTS: "-Xmx4g"

      - name: 穿透式排障日志（终极定位）
        if: failure()
        run: |
          echo "=== 子模块编译日志（common）==="
          cat ~/.gradle/daemon/21.0.0/daemon-*.out.log 2>/dev/null | grep -E ":common:.*(ERROR|Failed|Exception)" | tail -200
          echo "=== 子模块编译日志（xposed）==="
          cat ~/.gradle/daemon/21.0.0/daemon-*.out.log 2>/dev/null | grep -E ":xposed:.*(ERROR|Failed|Exception)" | tail -200
          echo "=== app 模块编译日志 ==="
          cat ~/.gradle/daemon/21.0.0/daemon-*.out.log 2>/dev/null | grep -E ":app:.*(ERROR|Failed|Exception)" | tail -200
          echo "=== 环境变量全量输出 ==="
          env | grep -E "ANDROID|NDK|JAVA|GRADLE" | sort
          echo "=== 子模块依赖配置 ==="
          cat common/build.gradle.kts 2>/dev/null | grep -E "implementation|api|compileOnly"
          cat xposed/build.gradle.kts 2>/dev/null | grep -E "implementation|api|compileOnly"

      - name: Upload Release APK
        if: success() && steps.buildAll.outputs.releaseFile != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.buildAll.outputs.releaseName }}
          path: ${{ steps.buildAll.outputs.releaseFile }}
          retention-days: 30

      - name: Upload Debug APK
        if: success() && steps.buildAll.outputs.debugFile != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.buildAll.outputs.debugName }}
          path: ${{ steps.buildAll.outputs.debugFile }}
          retention-days: 30
