name: Main

on:
  push:
    branches: [ master ]
    paths-ignore:
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/workflows/issue.yml'
      - '.github/workflows/pull_request.yml'
      - '**.md'
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
    if: ${{ !startsWith(github.event.head_commit.message, '[skip ci]') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: 配置 Android SDK（全组件安装）
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0
          ndk-version: 26.1.10909125
          cmake-version: 3.22.1
          components: |
            platform-tools
            tools
            build-tools;34.0.0
            platforms;android-34
            ndk;26.1.10909125
            extras;android;m2repository
            extras;google;m2repository

      - name: 终极闭环修复（子模块路径+根项目配置）
        shell: bash
        run: |
          set +e
          APP_GRADLE_KTS="app/build.gradle.kts"
          ROOT_GRADLE_KTS="build.gradle.kts"
          SETTINGS_GRADLE_KTS="settings.gradle.kts"

          # 1. 自动检测子模块路径并配置 settings.gradle.kts（关键修复）
          chmod +w "$SETTINGS_GRADLE_KTS" 2>/dev/null || true
          # 清空原有子模块配置，重新自动生成
          sed -i '/include(":common")/d' "$SETTINGS_GRADLE_KTS"
          sed -i '/include(":xposed")/d' "$SETTINGS_GRADLE_KTS"
          sed -i '/project(":common").projectDir/d' "$SETTINGS_GRADLE_KTS"
          sed -i '/project(":xposed").projectDir/d' "$SETTINGS_GRADLE_KTS"

          # 自动查找 common/xposed 模块的真实路径
          COMMON_PATH=$(find . -type d -name "common" | grep -E "/common$" | head -1)
          XPOSED_PATH=$(find . -type d -name "xposed" | grep -E "/xposed$" | head -1)

          # 添加子模块配置（含路径）
          if [ -n "$COMMON_PATH" ]; then
            echo 'include(":common")' >> "$SETTINGS_GRADLE_KTS"
            echo "project(":common").projectDir = file(\"$COMMON_PATH\")" >> "$SETTINGS_GRADLE_KTS"
            echo "✅ 自动配置 common 模块路径：$COMMON_PATH"
          else
            echo "❌ 未找到 common 模块，编译可能失败"
          fi

          if [ -n "$XPOSED_PATH" ]; then
            echo 'include(":xposed")' >> "$SETTINGS_GRADLE_KTS"
            echo "project(":xposed").projectDir = file(\"$XPOSED_PATH\")" >> "$SETTINGS_GRADLE_KTS"
            echo "✅ 自动配置 xposed 模块路径：$XPOSED_PATH"
          else
            echo "❌ 未找到 xposed 模块，编译可能失败"
          fi

          # 2. 根项目添加 Android 统一配置（子模块继承）
          chmod +w "$ROOT_GRADLE_KTS" 2>/dev/null || true
          if ! grep -q 'alias(libs.plugins.agp.library)' "$ROOT_GRADLE_KTS"; then
            # 在根项目 plugins 块添加 Android 库插件（子模块依赖）
            sed -i '/plugins {/a \
              alias(libs.plugins.agp.library) apply false\
              alias(libs.plugins.kotlin.android) apply false\
              alias(libs.plugins.kotlin.jvm) apply false\
            ' "$ROOT_GRADLE_KTS"
          fi

          # 3. 注入 rootProject.extra 属性（保留正确逻辑）
          REAL_PACKAGE=$(grep -r "namespace" "$APP_GRADLE_KTS" | sed -n 's/.*namespace\s*["'\'']\([^"'\'']*\)["'\''].*/\1/p' | head -1)
          REAL_PACKAGE=${REAL_PACKAGE:-"com.frknkrc44.hma"}
          sed -i '/rootProject.extra {/,/}/d' "$ROOT_GRADLE_KTS"
          sed -i '1i \
          rootProject.extra { \
              set("appPackageName", "'"$REAL_PACKAGE"'") \
              set("crowdinProjectId", "") \
              set("crowdinApiKey", "") \
              set("localBuild", true) \
              set("officialBuild", false) \
          }\
          ' "$ROOT_GRADLE_KTS"

          # 4. 全模块清理+Toolchain 同步
          for MODULE in app "$COMMON_PATH" "$XPOSED_PATH"; do
            [ -z "$MODULE" ] && continue
            MODULE_GRADLE="$MODULE/build.gradle.kts"
            if [ -f "$MODULE_GRADLE" ]; then
              chmod +w "$MODULE_GRADLE" 2>/dev/null || true
              sed -i '/crowdin/d' "$MODULE_GRADLE"
              sed -i 's/jvmToolchain(17)/jvmToolchain(21)/g' "$MODULE_GRADLE" 2>/dev/null
              # 子模块添加 Android 配置继承（若缺失）
              if ! grep -q 'android {' "$MODULE_GRADLE"; then
                echo '
                android {
                    namespace = "'"$REAL_PACKAGE"'.'"$(basename "$MODULE")"'"
                    compileSdk = 34
                    defaultConfig {
                        minSdk = 24
                    }
                    compileOptions {
                        sourceCompatibility = JavaVersion.VERSION_21
                        targetCompatibility = JavaVersion.VERSION_21
                    }
                    kotlinOptions {
                        jvmTarget = "21"
                    }
                }
                ' >> "$MODULE_GRADLE"
              fi
            fi
          done

          # 5. 验证配置结果
          echo "=== 最终 settings.gradle.kts 配置 ==="
          cat "$SETTINGS_GRADLE_KTS" 2>/dev/null
          echo "=== 子模块路径验证 ==="
          [ -n "$COMMON_PATH" ] && ls -la "$COMMON_PATH" 2>/dev/null || echo "common 模块缺失"
          [ -n "$XPOSED_PATH" ] && ls -la "$XPOSED_PATH" 2>/dev/null || echo "xposed 模块缺失"

          set -e
          echo "=== 闭环修复完成 ==="

      - name: Gradle wrapper validation
        uses: gradle/wrapper-validation-action@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Write key
        if: github.event_name != 'pull_request' && github.ref == 'refs/heads/master'
        run: |
          echo officialBuild=false >> local.properties

      - name: 全缓存清理（彻底解决缓存污染）
        run: |
          rm -rf ~/.gradle/caches/*
          rm -rf ~/.gradle/wrapper/*
          rm -rf app/build/
          rm -rf common/build/ 2>/dev/null
          rm -rf xposed/build/ 2>/dev/null
          echo "✅ 已清理所有 Gradle 缓存和构建产物"

      - name: 编译前验证子模块
        run: |
          ./gradlew projects --no-daemon | grep -E "(Root project|Project ':common'|Project ':xposed')" || true
          ./gradlew :common:tasks --no-daemon | grep "compileKotlin" 2>/dev/null || echo "common 模块无 compileKotlin 任务"
          ./gradlew :xposed:tasks --no-daemon | grep "compileKotlin" 2>/dev/null || echo "xposed 模块无 compileKotlin 任务"

      - name: Build all（最终稳定版）
        id: buildAll
        run: |
          export ANDROID_HOME=/usr/local/lib/android/sdk
          export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
          ./gradlew :common:assemble :xposed:assemble :app:assembleDebug :app:assembleRelease --no-daemon --stacktrace --info
          # 安全提取 APK 路径
          RELEASE_FILE=$(find app/build/outputs/apk/release -name "*.apk" | head -1 || echo "")
          DEBUG_FILE=$(find app/build/outputs/apk/debug -name "*.apk" | head -1 || echo "")
          echo "releaseName=$(basename "$RELEASE_FILE" 2>/dev/null)" >> $GITHUB_OUTPUT
          echo "debugName=$(basename "$DEBUG_FILE" 2>/dev/null)" >> $GITHUB_OUTPUT
          echo "releaseFile=$RELEASE_FILE" >> $GITHUB_OUTPUT
          echo "debugFile=$DEBUG_FILE" >> $GITHUB_OUTPUT
          echo "ossNum=$(basename "$DEBUG_FILE" 2>/dev/null | awk -F '-' '{print $4}' | sed 's/.apk//' 2>/dev/null)" >> $GITHUB_OUTPUT

      - name: 终极排障日志（最后一次）
        if: failure()
        run: |
          echo "=== 环境变量验证 ==="
          env | grep -E "ANDROID|JAVA" | sort
          echo "=== 子模块编译日志（common）==="
          cat ~/.gradle/daemon/21.0.0/daemon-*.out.log 2>/dev/null | grep -E ":common:.*(ERROR|Failed)" | tail -100
          echo "=== 子模块编译日志（xposed）==="
          cat ~/.gradle/daemon/21.0.0/daemon-*.out.log 2>/dev/null | grep -E ":xposed:.*(ERROR|Failed)" | tail -100
          echo "=== app 模块编译日志 ==="
          cat ~/.gradle/daemon/21.0.0/daemon-*.out.log 2>/dev/null | grep -E ":app:.*(ERROR|Failed)" | tail -100
          echo "=== 依赖下载日志 ==="
          cat ~/.gradle/daemon/21.0.0/daemon-*.out.log 2>/dev/null | grep -E "Download|Failed to download" | tail -50

      - name: Upload Release APK
        if: success() && steps.buildAll.outputs.releaseFile != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.buildAll.outputs.releaseName }}
          path: ${{ steps.buildAll.outputs.releaseFile }}
          retention-days: 30

      - name: Upload Debug APK
        if: success() && steps.buildAll.outputs.debugFile != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.buildAll.outputs.debugName }}
          path: ${{ steps.buildAll.outputs.debugFile }}
          retention-days: 30
